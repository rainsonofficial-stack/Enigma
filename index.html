<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>OS | Lockscreen</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* General Reset & Body */
        html { 
            height: 100%; /* Fix PWA height bug */
        }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent scrolling */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%; /* Fix PWA height bug */
            background: #000;
        }

        /* App Container (Simulates Phone Screen) */
        #app {
            width: 100%;
            height: 100%; 
            max-width: 600px;
            max-height: 100vh;
            position: relative;
            background-size: cover;
            background-position: center;
            transition: all 0.3s ease-in-out;
            color: white;
            z-index: 10;
            /* HARDCODED BACKGROUND IMAGE */
            background-image: url('home.jpg'); 
        }

        /* --- Lockscreen UI --- */
        #lockscreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Semi-transparent blur on top of home.jpg */
            background: rgba(0, 0, 0, 0.7); 
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 50px;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }

        .time-display {
            font-size: 80px;
            font-weight: 300;
            margin-bottom: 10px;
            color: white;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            user-select: none;
            cursor: pointer;
        }
        .date-display {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 50px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Passcode & Keypad */
        .passcode-display {
            display: flex;
            gap: 15px;
            margin-bottom: 50px;
        }
        .passcode-dot {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .passcode-dot.active {
            background-color: white;
            border-color: white;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 80%;
            max-width: 300px;
        }
        .keypad-button {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            font-weight: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s;
        }
        .keypad-button:active {
            background: rgba(255, 255, 255, 0.3);
        }
        .keypad-row {
            display: contents;
        }

        /* --- Home Screen UI --- */
        #home-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
        }
        #home-screen.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Discreet Reveal Area: Lower Right (Fixed Position) */
        #reveal-area {
            position: absolute;
            bottom: 4%; 
            right: 2%; 
            font-size: 11px;
            color: rgba(0, 0, 0, 0.8); 
            background: rgba(255, 255, 255, 0.7); 
            padding: 1px 4px;
            border-radius: 3px;
            z-index: 100;
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        /* Status Bar Container */
        .status-bar {
            position: absolute; 
            top: 10px; 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            padding: 0 15px; 
            box-sizing: border-box; 
            font-size: 15px; 
            font-weight: 600; 
            z-index: 101;
            padding-right: 25px; 
        }
        
        /* Disambiguation Area (Notification/Widget Style) */
        #disambiguation-ui {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 350px;
            background: rgba(45, 45, 45, 0.9);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 99;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #disambiguation-ui.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        #disambiguation-ui h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 500;
            color: #ccc;
        }
        
        .chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .letter-chip {
            padding: 8px 12px;
            background-color: #007aff;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s;
        }
        .letter-chip:hover {
            background-color: #005bb5;
        }

        .fallback-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fallback-input input {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 20px;
            text-transform: uppercase;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
        }
        #no-match-msg {
            font-size: 12px;
            color: #ff3b30;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="lockscreen">
            <div class="time-display" id="lock-time"></div>
            <div class="date-display" id="lock-date"></div>

            <div class="passcode-display">
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
                <div class="passcode-dot"></div>
            </div>

            <div class="keypad">
                <div class="keypad-row">
                    <button class="keypad-button" data-key="1">1</button>
                    <button class="keypad-button" data-key="2">2</button>
                    <button class="keypad-button" data-key="3">3</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-button" data-key="4">4</button>
                    <button class="keypad-button" data-key="5">5</button>
                    <button class="keypad-button" data-key="6">6</button>
                </div>
                <div class="keypad-row">
                    <button class="keypad-button" data-key="7">7</button>
                    <button class="keypad-button" data-key="8">8</button>
                    <button class="keypad-button" data-key="9">9</button>
                </div>
                <div class="keypad-row">
                    <div class="keypad-button" style="background: none;"></div>
                    <button class="keypad-button" data-key="0">0</button>
                    <button class="keypad-button" data-key="del">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="home-screen" class="hidden">
            
            <div id="reveal-area">NO MATCH</div>
            
            <div id="disambiguation-ui" class="hidden">
                <h4 id="disamb-header"></h4>
                <div id="disamb-content">
                    </div>
                <div id="no-match-msg">No word matches that letter. Try another.</div>
            </div>

            <div class="status-bar">
                <span id="home-time">8:00 AM</span> 
                <span style="display: flex; gap: 5px;">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M5 20h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-4H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2zM17 10v4M12 10v4M7 10v4"></path></svg>
                </span>
            </div>

        </div>
    </div>

    <script>
        // --- Core Application Logic ---

        const APP = {
            defaultDictionary: ["BOTTLE", "KETTLE", "APPLE", "SPOON", "CHAIR", "TABLE", "BOOK", "PEN", "TOWEL", "GLASS", "CLOCK", "PHONE", "SHIRT", "SOCK", "COFFEE", "CUP", "DOOR", "WINDOW", "CARPET", "KEYBOARD", "MOUSE", "GUITAR", "PIANO", "DRUM", "BALLOON", "CANDLE", "FLOWER", "LEMON", "ORANGE", "PEAR", "GRAPEFRUIT", "BANANA", "STRAWBERRY", "BLANKET", "CAMERA", "SCISSORS", "HAMMER", "NAIL", "SCREWDRIVER", "RULER", "GIFT", "WRENCH", "LAMP", "DISH", "VASE", "COAT", "HAT", "GLOVES", "WAGON"], 
            VOWELS: ['A', 'E', 'I', 'O', 'U'],
            PASSCODE: '',
            MATCHES: [],
            CURRENT_DICTIONARY: [], // Will be loaded from default
            
            // NOTE: isYVowel setting is removed, 'Y' is always treated as a consonant.

            LETTER_SHAPES: {
                1: new Set(['A', 'E', 'F', 'H', 'I', 'K', 'L', 'M', 'N', 'T', 'V', 'W', 'X', 'Y', 'Z']),
                2: new Set(['B', 'D', 'G', 'J', 'P', 'Q', 'R', 'U']),
                3: new Set(['C', 'O', 'S'])
            },

            // --- Vowel & Word Helper Functions ---
            isVowel(char) {
                const upper = char.toUpperCase();
                return this.VOWELS.includes(upper);
            },

            getVowelIndices(word) {
                const indices = [];
                for (let i = 0; i < word.length; i++) {
                    if (this.isVowel(word[i])) {
                        indices.push(i + 1); // 1-based position
                    }
                }
                return indices;
            },

            // --- The Core Matching Algorithm ---
            filterDictionary(passcode, currentMatches = null) {
                const dictionary = (currentMatches || this.CURRENT_DICTIONARY).map(w => w.toUpperCase());
                if (dictionary.length === 0) return [];
                
                const [d1, d2, d3, d4, d5, d6] = passcode.split('').map(Number);
                const lenA = d1;
                const lenB = d1 + 10;
                
                return dictionary.filter(word => {
                    const length = word.length;
                    
                    // Digit 1: Word Length (d or d+10)
                    if (length !== lenA && length !== lenB) return false;

                    const vIndices = this.getVowelIndices(word);
                    const vowelCount = vIndices.length;

                    // Digit 2: 1st Vowel Position
                    if (d2 > 0 && (vowelCount < 1 || vIndices[0] !== d2)) return false;

                    // Digit 3: 2nd Vowel Position (0 means exactly 1 vowel)
                    if (d3 === 0) {
                        if (vowelCount !== 1) return false;
                    } else if (d3 > 0) {
                        if (vowelCount < 2 || vIndices[1] !== d3) return false;
                    }

                    // Digit 4: 3rd Vowel Position (0 means wildcard)
                    if (d4 > 0) {
                        if (vowelCount < 3 || vIndices[2] !== d4) return false;
                    }

                    // Digit 5: 4th Vowel Position (0 means wildcard)
                    if (d5 > 0) {
                        if (vowelCount < 4 || vIndices[3] !== d5) return false;
                    }

                    // Digit 6: First Letter Shape (0 means wildcard)
                    if (d6 > 0) {
                        const firstLetter = word[0];
                        const shapeSet = this.LETTER_SHAPES[d6];
                        if (!shapeSet || !shapeSet.has(firstLetter)) return false;
                    }

                    return true;
                });
            },

            // --- Disambiguation Logic ---
            getDisambiguationIndex(matches) {
                if (matches.length <= 1) return { index: -1, letters: [], type: 'unique' };

                const maxLength = Math.max(...matches.map(w => w.length));
                let bestIndex = -1;
                
                for (let i = 1; i < maxLength; i++) { 
                    const lettersAtPosition = matches.map(word => word.length > i ? word[i] : null).filter(l => l !== null);
                    if (lettersAtPosition.length === 0) continue;

                    const uniqueLetters = new Set(lettersAtPosition);

                    if (uniqueLetters.size === lettersAtPosition.length) {
                        return { 
                            index: i + 1, 
                            letters: Array.from(uniqueLetters).sort(), 
                            type: 'unique' 
                        };
                    }

                    if (uniqueLetters.size > 1 && bestIndex === -1) {
                        bestIndex = i + 1;
                    }
                }

                if (bestIndex !== -1) {
                    const fallbackLetters = matches.map(word => word.length >= bestIndex ? word[bestIndex - 1] : null).filter(l => l !== null);
                    return { 
                        index: bestIndex, 
                        letters: Array.from(new Set(fallbackLetters)).sort(), 
                        type: 'fallback' 
                    };
                }

                return { index: -1, letters: [], type: 'unique' };
            },


            // --- UI/State Update Functions ---
            updateTime() {
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const date = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                document.getElementById('lock-time').textContent = time.replace(/\s(A|P)M/, '');
                document.getElementById('home-time').textContent = time;
                document.getElementById('lock-date').textContent = date;
            },

            updatePasscodeDots() {
                document.querySelectorAll('.passcode-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index < this.PASSCODE.length);
                });
            },

            revealWord(word) {
                document.getElementById('reveal-area').textContent = `ID: ${word}`;
                this.hideDisambiguationUI();
            },

            hideDiscreetReveal() {
                document.getElementById('reveal-area').textContent = 'NO MATCH';
                this.hideDisambiguationUI();
            },

            showDisambiguationUI(matches) {
                this.MATCHES = matches;
                const disambUI = document.getElementById('disambiguation-ui');
                const disambContent = document.getElementById('disamb-content');
                const disambResult = this.getDisambiguationIndex(matches);
                const { index, letters, type } = disambResult;

                disambContent.innerHTML = '';

                if (index === -1) {
                    this.revealWord('ERROR: AMBIGUOUS');
                    disambUI.classList.add('hidden');
                    return;
                }

                document.getElementById('disamb-header').textContent = `Clue: Letter at position ${index}`;
                disambUI.classList.remove('hidden');
                disambUI.classList.add('active');


                if (type === 'unique') {
                    const chipContainer = document.createElement('div');
                    chipContainer.classList.add('chip-container');
                    letters.forEach(letter => {
                        const chip = document.createElement('div');
                        chip.classList.add('letter-chip');
                        chip.textContent = letter;
                        chip.addEventListener('click', () => this.handleChipClick(letter, index));
                        chipContainer.appendChild(chip);
                    });
                    disambContent.appendChild(chipContainer);
                } else {
                    const fallbackInput = document.createElement('div');
                    fallbackInput.classList.add('fallback-input');
                    fallbackInput.innerHTML = `
                        <span>Type the letter:</span>
                        <input type="text" id="disamb-input" maxlength="1" autocapitalize="characters" placeholder="L" />
                    `;
                    disambContent.appendChild(fallbackInput);

                    const input = document.getElementById('disamb-input');
                    input.focus();
                    input.addEventListener('input', (e) => {
                        const char = e.target.value.toUpperCase();
                        if (char.length === 1 && char.match(/[A-Z]/)) {
                            this.handleFallbackInput(char, index);
                        } else if (char.length === 0) {
                            document.getElementById('no-match-msg').style.display = 'none';
                        }
                    });
                }
            },

            hideDisambiguationUI() {
                const disambUI = document.getElementById('disambiguation-ui');
                disambUI.classList.add('hidden');
                disambUI.classList.remove('active');
            },
            
            // --- Disambiguation Actions ---
            handleChipClick(letter, index) {
                const filtered = this.MATCHES.filter(word => word[index - 1] === letter);
                if (filtered.length === 1) {
                    this.revealWord(filtered[0]);
                } else {
                    this.showDisambiguationUI(filtered); 
                }
            },

            handleFallbackInput(letter, index) {
                document.getElementById('no-match-msg').style.display = 'none';
                const filtered = this.MATCHES.filter(word => word[index - 1] === letter);

                if (filtered.length === 0) {
                    document.getElementById('no-match-msg').style.display = 'block';
                } else if (filtered.length === 1) {
                    this.revealWord(filtered[0]);
                } else {
                    this.showDisambiguationUI(filtered);
                }
            },

            // --- Lock/Unlock Flow (Passcode Logic) ---
            async handlePasscode(digit) {
                if (digit === 'del') {
                    this.PASSCODE = this.PASSCODE.slice(0, -1);
                } else if (this.PASSCODE.length < 6) {
                    this.PASSCODE += digit;
                }

                this.updatePasscodeDots();

                if (this.PASSCODE.length === 6) {
                    await new Promise(r => setTimeout(r, 200)); 
                    this.unlock();
                }
            },

            async unlock() {
                const lockscreen = document.getElementById('lockscreen');
                const homeScreen = document.getElementById('home-screen');

                this.MATCHES = this.filterDictionary(this.PASSCODE);

                if (this.MATCHES.length === 1) {
                    this.revealWord(this.MATCHES[0]);
                } else if (this.MATCHES.length > 1) {
                    this.showDisambiguationUI(this.MATCHES);
                } else {
                    this.hideDiscreetReveal();
                }

                lockscreen.style.transition = 'opacity 0.5s';
                lockscreen.style.opacity = '0';
                
                await new Promise(r => setTimeout(r, 500));
                
                lockscreen.classList.add('hidden');
                homeScreen.classList.remove('hidden');
                homeScreen.classList.add('active');
                
                this.PASSCODE = '';
                this.updatePasscodeDots();
            },

            // --- Initialization ---
            async init() {
                // Register Service Worker for PWA/Offline
                if ('serviceWorker' in navigator) {
                    try {
                        await navigator.serviceWorker.register('sw.js');
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
                
                this.CURRENT_DICTIONARY = this.defaultDictionary;

                document.querySelectorAll('.keypad-button').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handlePasscode(button.getAttribute('data-key'));
                    });
                });
                
                this.updateTime();
                setInterval(() => this.updateTime(), 1000); 
            }
        };

        // Initialize the application
        APP.init();
    </script>
</body>
</html>
